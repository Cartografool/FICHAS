<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>NPCs</title>

    <style>
      body {
        margin: 0;
        background: #0b0b0b;
        color: #eee;
        font-family: Arial, sans-serif;
      }

      .container {
        width: 900px;
        margin: 30px auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .header button {
        padding: 8px 14px;
        background: #7c3aed;
        border: none;
        color: white;
        cursor: pointer;
      }

      .npc {
        display: flex;
        align-items: center;
        padding: 14px;
        border: 1px solid #222;
        margin-bottom: 10px;
        background: linear-gradient(90deg, #0f0f0f, #111);
      }

      .npc img {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border: 1px solid #444;
        margin-right: 16px;
      }

      .npc-info {
        flex: 1;
      }

      .npc-actions button {
        margin-left: 6px;
        padding: 6px 14px;
        font-size: 13px;
        border-radius: 6px;
        cursor: pointer;
      }

      .btn-ficha {
        background: #7c3aed;
        border: 1px solid #5b21b6;
        color: #fff;
      }

      .btn-editar {
        background: #1e40af;
        border: 1px solid #1e3a8a;
        color: #fff;
      }

      .btn-remover {
        background: #450a0a;
        border: 1px solid #7f1d1d;
        color: #fff;
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10;
      }

      .modal-content {
        background: #111;
        padding: 20px;
        width: 320px;
        border: 1px solid #333;
      }

      .modal-content input,
      .modal-content select,
      .modal-content textarea {
        width: 100%;
        margin-bottom: 10px;
        padding: 6px;
        background: #000;
        color: #eee;
        border: 1px solid #444;
      }

      .modal-content label {
        font-size: 12px;
        color: #aaa;
      }

      .modal-content button {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
        background: #7c3aed;
        border: none;
        color: white;
        cursor: pointer;
      }

      .ficha-card {
        background: #0f0f0f;
        width: 430px;
        border: 1px solid #333;
        padding: 14px;
      }

      .ficha-top {
        display: flex;
        gap: 14px;
        margin-bottom: 12px;
      }

      .ficha-top img {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border: 1px solid #444;
      }

      .vida-container {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .vida-barra {
        position: relative;
        flex: 1;
        height: 34px;
        background: #300;
        border: 1px solid #700;
      }

      #vida-barra-fill {
        height: 100%;
        background: #b91c1c;
      }

      #vida-texto {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      .btn-neg {
        background: linear-gradient(#7f1d1d, #450a0a);
        border: 1px solid #991b1b;
        color: #fff;
      }

      .btn-pos {
        background: linear-gradient(#14532d, #052e16);
        border: 1px solid #166534;
        color: #fff;
      }

      .descricao {
        margin-top: 12px;
        padding: 10px;
        background: #0b0b0b;
        border: 1px solid #222;
        color: #ccc;
        white-space: pre-wrap;
      }

      .fechar-btn {
        margin-top: 12px;
        width: 100%;
        background: #444;
        border: none;
        padding: 8px;
        color: #fff;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h2>NPCs</h2>
        <button onclick="openModal()">Adicionar NPC</button>
      </div>
      <div id="npc-list"></div>
    </div>

    <div class="modal" id="modal">
      <div class="modal-content">
        <input id="nome" placeholder="Nome" />
        <input id="vida" type="number" placeholder="Vida Máxima" />

        <select id="tipo">
          <option>Pessoa - Médio</option>
          <option>Criatura - Médio</option>
          <option>Criatura - Grande</option>
        </select>

        <label>Imagem</label>
        <input id="imagem" type="file" accept="image/*" />

        <label>Imagem X</label>
        <input id="imgX" type="range" min="0" max="100" value="50" />

        <label>Imagem Y</label>
        <input id="imgY" type="range" min="0" max="100" value="50" />

        <textarea id="descricao" rows="4" placeholder="Descrição"></textarea>

        <button onclick="confirmarNPC()">Salvar</button>
        <button onclick="closeModal()" style="background: #444">
          Cancelar
        </button>
      </div>
    </div>

    <div class="modal" id="fichaModal">
      <div class="ficha-card">
        <div class="ficha-top">
          <img id="ficha-img" />
          <div>
            <h2 id="ficha-nome"></h2>
            <p>
              <strong>VD:</strong> <span id="vidaMax"></span><br />
              <span id="ficha-tipo"></span>
            </p>
          </div>
        </div>

        <div class="vida-container">
          <button class="btn-neg" onclick="alterarVida(-5)">-5</button>
          <button class="btn-neg" onclick="alterarVida(-1)">-1</button>

          <div class="vida-barra">
            <div id="vida-barra-fill"></div>
            <span id="vida-texto"></span>
          </div>

          <button class="btn-pos" onclick="alterarVida(1)">+1</button>
          <button class="btn-pos" onclick="alterarVida(5)">+5</button>
        </div>

        <div class="descricao">
          <strong>Descrição</strong>
          <span id="ficha-descricao"></span>
        </div>

        <button onclick="editarNPC()">Editar</button>
        <button class="fechar-btn" onclick="fecharFicha()">Fechar</button>
      </div>
    </div>

    <script>
      const STORAGE_KEY = "npc_list";
      let npcs = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      let fichaAtualId = null;
      let editandoId = null;
      let imagemTemp = null;

      const imgInput = document.getElementById("imagem");

      imgInput.addEventListener("change", () => {
        const file = imgInput.files[0];
        if (!file) return;

        const img = new Image();
        const reader = new FileReader();

        reader.onload = () => (img.src = reader.result);

        img.onload = () => {
          const canvas = document.createElement("canvas");
          const size = 256;

          canvas.width = size;
          canvas.height = size;

          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, size, size);

          imagemTemp = canvas.toDataURL("image/jpeg", 0.7);
        };

        reader.readAsDataURL(file);
      });

      function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(npcs));
      }

      function render() {
        const list = document.getElementById("npc-list");
        list.innerHTML = "";

        npcs.forEach((n) => {
          list.innerHTML += `
          <div class="npc">
            <img src="${n.imagem || ""}" style="object-position:${n.imgX}% ${
            n.imgY
          }%">
            <div class="npc-info">
              <strong>${n.nome}</strong><br>
              Vida ${n.vidaAtual}/${n.vidaMax}<br>
              ${n.tipo}
            </div>
            <div class="npc-actions">
              <button class="btn-ficha" onclick="openFicha('${
                n.id
              }')">Ficha</button>
              <button class="btn-editar" onclick="editarNPC('${
                n.id
              }')">Editar</button>
              <button class="btn-remover" onclick="removerNPC('${
                n.id
              }')">Remover</button>
            </div>
          </div>`;
        });
      }

      function openFicha(id) {
        const npc = npcs.find((n) => n.id === id);
        fichaAtualId = id;

        document.getElementById("ficha-img").src = npc.imagem || "";
        document.getElementById(
          "ficha-img"
        ).style.objectPosition = `${npc.imgX}% ${npc.imgY}%`;
        document.getElementById("ficha-nome").innerText = npc.nome;
        document.getElementById("ficha-tipo").innerText = npc.tipo;
        document.getElementById("vidaMax").innerText = npc.vidaMax;
        document.getElementById("ficha-descricao").innerText =
          npc.descricao || "—";

        atualizarBarraVida(npc);
        document.getElementById("fichaModal").style.display = "flex";
      }

      function alterarVida(v) {
        const npc = npcs.find((n) => n.id === fichaAtualId);
        npc.vidaAtual = Math.max(0, Math.min(npc.vidaAtual + v, npc.vidaMax));
        atualizarBarraVida(npc);
        save();
      }

      function atualizarBarraVida(npc) {
        const p = (npc.vidaAtual / npc.vidaMax) * 100;
        document.getElementById("vida-barra-fill").style.width = p + "%";
        document.getElementById(
          "vida-texto"
        ).innerText = `${npc.vidaAtual} / ${npc.vidaMax}`;
      }

      function fecharFicha() {
        document.getElementById("fichaModal").style.display = "none";
        render();
      }

      function openModal() {
        editandoId = null;
        imagemTemp = null;
        nome.value = vida.value = descricao.value = "";
        imgX.value = imgY.value = 50;
        modal.style.display = "flex";
      }

      function confirmarNPC() {
        if (!nome.value || vida.value <= 0) return;

        if (editandoId) {
          const n = npcs.find((n) => n.id === editandoId);
          Object.assign(n, {
            nome: nome.value,
            vidaMax: +vida.value,
            vidaAtual: Math.min(n.vidaAtual, vida.value),
            tipo: tipo.value,
            descricao: descricao.value,
            imagem: imagemTemp || n.imagem,
            imgX: imgX.value,
            imgY: imgY.value,
          });
        } else {
          npcs.push({
            id: crypto.randomUUID(),
            nome: nome.value,
            vidaAtual: +vida.value,
            vidaMax: +vida.value,
            tipo: tipo.value,
            descricao: descricao.value,
            imagem: imagemTemp,
            imgX: imgX.value,
            imgY: imgY.value,
          });
        }

        save();
        closeModal();
        render();
      }

      function editarNPC(id = fichaAtualId) {
        const n = npcs.find((n) => n.id === id);
        editandoId = id;

        nome.value = n.nome;
        vida.value = n.vidaMax;
        tipo.value = n.tipo;
        descricao.value = n.descricao;
        imgX.value = n.imgX;
        imgY.value = n.imgY;
        imagemTemp = n.imagem;

        fecharFicha();
        modal.style.display = "flex";
      }

      function removerNPC(id) {
        if (!confirm("Remover NPC?")) return;
        npcs = npcs.filter((n) => n.id !== id);
        save();
        render();
      }

      function closeModal() {
        modal.style.display = "none";
      }

      render();
    </script>
  </body>
</html>
