<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>NPCs</title>

    <style>
      body {
        margin: 0;
        background: #0b0b0b;
        color: #eee;
        font-family: Arial, sans-serif;
      }

      .container {
        width: 900px;
        margin: 30px auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .header button {
        padding: 8px 14px;
        background: #7c3aed;
        border: none;
        color: white;
        cursor: pointer;
      }

      .npc {
        display: flex;
        align-items: center;
        padding: 14px;
        border: 1px solid #222;
        margin-bottom: 10px;
        background: linear-gradient(90deg, #0f0f0f, #111);
      }

      .npc img {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border: 1px solid #444;
        margin-right: 16px;
      }

      .npc-info {
        flex: 1;
      }

      .npc-actions button {
        margin-left: 8px;
        padding: 6px 12px;
        background: none;
        border: 1px solid #666;
        color: #eee;
        cursor: pointer;
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10;
      }

      .modal-content {
        background: #111;
        padding: 20px;
        width: 320px;
        border: 1px solid #333;
      }

      .modal-content input,
      .modal-content select,
      .modal-content textarea {
        width: 100%;
        margin-bottom: 10px;
        padding: 6px;
        background: #000;
        color: #eee;
        border: 1px solid #444;
        resize: vertical;
      }

      .modal-content button {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
        background: #7c3aed;
        border: none;
        color: white;
        cursor: pointer;
      }

      .ficha-card {
        background: #0f0f0f;
        width: 430px;
        border: 1px solid #333;
        padding: 14px;
      }

      .ficha-top {
        display: flex;
        gap: 14px;
        margin-bottom: 12px;
      }

      .ficha-top img {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border: 1px solid #444;
      }

      .vida-container {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .vida-barra {
        position: relative;
        flex: 1;
        height: 34px;
        background: #300;
        border: 1px solid #700;
      }

      #vida-barra-fill {
        height: 100%;
        background: #b91c1c;
        transition: width 0.2s;
      }

      #vida-texto {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      /* NOVA SEÇÃO DE DESCRIÇÃO */
      .descricao {
        margin-top: 12px;
        padding: 10px;
        background: #0b0b0b;
        border: 1px solid #222;
        font-size: 14px;
        color: #ccc;
        white-space: pre-wrap;
      }

      .descricao strong {
        color: #eee;
        display: block;
        margin-bottom: 4px;
      }

      .fechar-btn {
        margin-top: 12px;
        width: 100%;
        background: #444;
        border: none;
        padding: 8px;
        color: #fff;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h2>NPCs</h2>
        <button onclick="openModal()">Adicionar NPC</button>
      </div>

      <div id="npc-list"></div>
    </div>

    <!-- MODAL NOVO NPC -->
    <div class="modal" id="modal">
      <div class="modal-content">
        <h3>Novo NPC</h3>

        <input id="nome" placeholder="Nome" />
        <input id="vida" type="number" placeholder="Vida Máxima (VD)" />
        <select id="tipo">
          <option>Pessoa - Médio</option>
          <option>Criatura - Médio</option>
          <option>Criatura - Grande</option>
        </select>

        <!-- DESCRIÇÃO -->
        <textarea
          id="descricao"
          rows="4"
          placeholder="Descrição do personagem..."
        ></textarea>

        <input id="imgInput" type="file" accept="image/*" />

        <button onclick="addNPC()">Adicionar</button>
        <button onclick="closeModal()" style="background: #444">
          Cancelar
        </button>
      </div>
    </div>

    <!-- MODAL FICHA -->
    <div class="modal" id="fichaModal">
      <div class="ficha-card">
        <div class="ficha-top">
          <img id="ficha-img" />
          <div class="ficha-info">
            <h2 id="ficha-nome"></h2>
            <p>
              <strong>VD:</strong> <span id="vidaMax"></span><br />
              <span id="ficha-tipo"></span>
            </p>
          </div>
        </div>

        <div class="vida-container">
          <button onclick="alterarVida(-1)">«</button>
          <div class="vida-barra">
            <div id="vida-barra-fill"></div>
            <span id="vida-texto"></span>
          </div>
          <button onclick="alterarVida(1)">»</button>
        </div>

        <!-- DESCRIÇÃO NA FICHA -->
        <div class="descricao" id="ficha-descricao">
          <strong>Descrição</strong>
          <span></span>
        </div>

        <button class="fechar-btn" onclick="fecharFicha()">Fechar</button>
      </div>
    </div>

    <script>
      const STORAGE_KEY = "npc_list";
      const MAX_NPCS = 30;

      let npcs = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      let tempImage = "";
      let fichaAtualId = null;

      const nomeInput = document.getElementById("nome");
      const vidaInput = document.getElementById("vida");
      const tipoInput = document.getElementById("tipo");
      const descInput = document.getElementById("descricao");
      const imgInput = document.getElementById("imgInput");

      /* conversão de imagem */
      imgInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const max = 512;
          let w = img.width;
          let h = img.height;

          if (w > h && w > max) {
            h *= max / w;
            w = max;
          } else if (h > max) {
            w *= max / h;
            h = max;
          }

          canvas.width = w;
          canvas.height = h;
          canvas.getContext("2d").drawImage(img, 0, 0, w, h);
          tempImage = canvas.toDataURL("image/jpeg", 0.75);
        };

        img.src = URL.createObjectURL(file);
      });

      function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(npcs));
      }

      function render() {
        const list = document.getElementById("npc-list");
        list.innerHTML = "";

        npcs.forEach((npc) => {
          list.innerHTML += `
            <div class="npc">
              <img src="${npc.imagem || ""}">
              <div class="npc-info">
                <strong>${npc.nome}</strong><br>
                Vida: ${npc.vidaAtual}/${npc.vidaMax}<br>
                ${npc.tipo}
              </div>
              <div class="npc-actions">
                <button onclick="openFicha('${npc.id}')">Ficha</button>
                <button onclick="removeNPC('${npc.id}')">Remover</button>
              </div>
            </div>
          `;
        });
      }

      function openModal() {
        if (npcs.length >= MAX_NPCS) return alert("Limite de NPCs atingido");
        tempImage = "";
        imgInput.value = "";
        document.getElementById("modal").style.display = "flex";
      }

      function closeModal() {
        document.getElementById("modal").style.display = "none";
        nomeInput.value = "";
        vidaInput.value = "";
        tipoInput.selectedIndex = 0;
        descInput.value = "";
        tempImage = "";
      }

      function addNPC() {
        const nome = nomeInput.value.trim();
        const vida = parseInt(vidaInput.value, 10);

        if (!nome || !vida) return;

        npcs.push({
          id: crypto.randomUUID(),
          nome,
          vidaAtual: vida,
          vidaMax: vida,
          tipo: tipoInput.value,
          descricao: descInput.value.trim(),
          imagem: tempImage,
        });

        save();
        closeModal();
        render();
      }

      function removeNPC(id) {
        npcs = npcs.filter((n) => n.id !== id);
        save();
        render();
      }

      function openFicha(id) {
        const npc = npcs.find((n) => n.id === id);
        fichaAtualId = id;

        document.getElementById("ficha-nome").innerText = npc.nome;
        document.getElementById("ficha-tipo").innerText = npc.tipo;
        document.getElementById("vidaMax").innerText = npc.vidaMax;
        document.getElementById("ficha-img").src = npc.imagem || "";

        document.querySelector("#ficha-descricao span").innerText =
          npc.descricao || "—";

        atualizarBarraVida(npc);
        document.getElementById("fichaModal").style.display = "flex";
      }

      function alterarVida(valor) {
        const npc = npcs.find((n) => n.id === fichaAtualId);
        npc.vidaAtual = Math.max(
          0,
          Math.min(npc.vidaAtual + valor, npc.vidaMax)
        );
        atualizarBarraVida(npc);
        save();
        render();
      }

      function atualizarBarraVida(npc) {
        const perc = (npc.vidaAtual / npc.vidaMax) * 100;
        document.getElementById("vida-barra-fill").style.width = perc + "%";
        document.getElementById("vida-texto").innerText =
          npc.vidaAtual + " / " + npc.vidaMax;
      }

      function fecharFicha() {
        document.getElementById("fichaModal").style.display = "none";
        fichaAtualId = null;
      }

      render();
    </script>
  </body>
</html>
